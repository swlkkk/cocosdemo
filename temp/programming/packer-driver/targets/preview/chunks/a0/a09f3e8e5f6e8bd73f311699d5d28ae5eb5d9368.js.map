{"version":3,"sources":["file:///Users/swl/Downloads/cocosPusher/extensions/localization-editor/static/assets/core/resource-data-manager.ts"],"names":["ResourceDataManager","assetManager","settings","Settings","BUILD","EDITOR","mainName","pluginName","resourceBundlePath","resourceListPath","runtimeBundleName","readResourceList","Editor","Message","request","console","log","runtimeLoad","previewLoad","readResourceBundle","tags","editorLoad","locales","fileName","bundle","getBundle","undefined","jsonAsset","getResource","json","urlPath","fetch","e","checkBundle","bundleName","queryResult","querySettings","Category","ASSETS","find","it","Promise","resolve","loadBundle","error","resourceName","load","asset"],"mappings":";;;kMAMqBA,mB;;;;;;;;;;;;;AAJEC,MAAAA,Y,OAAAA,Y;AAAyBC,MAAAA,Q,OAAAA,Q;AAAUC,MAAAA,Q,OAAAA,Q;;AADjDC,MAAAA,K,UAAAA,K;AAAOC,MAAAA,M,UAAAA,M;;AAGPC,MAAAA,Q,gBAAAA,Q;AAAUC,MAAAA,U,gBAAAA,U;AAAYC,MAAAA,kB,gBAAAA,kB;AAAoBC,MAAAA,gB,gBAAAA,gB;AAAkBC,MAAAA,iB,gBAAAA,iB;;;6FAJrE;;;;;yBAMqBV,mB,GAAN,MAAMA,mBAAN,CAA0B;AAC/BW,QAAAA,gBAAgB,GAA0B;AAAA;;AAAA;AAC5C,gBAAIN,MAAJ,EAAY;AACR,qBAAOO,MAAM,CAACC,OAAP,CAAeC,OAAf,CAAuBR,QAAvB,EAAiC,mBAAjC,CAAP;AACH,aAFD,MAEO,IAAIF,KAAJ,EAAW;AACdW,cAAAA,OAAO,CAACC,GAAR,OAAgBT,UAAhB;AACA,qBAAO,KAAI,CAACU,WAAL,CAAiBR,gBAAjB,CAAP;AACH,aAHM,MAGA;AACH,qBAAO,KAAI,CAACS,WAAL,CAAiBT,gBAAjB,CAAP;AACH;AAR2C;AAS/C;;AAEKU,QAAAA,kBAAkB,CAACC,IAAD,EAAyD;AAAA;;AAAA;AAC7E,gBAAIf,MAAJ,EAAY;AACR,qBAAO,MAAI,CAACgB,UAAL,CAAgBD,IAAhB,CAAP;AACH,aAFD,MAEO,IAAIhB,KAAJ,EAAW;AACd,qBAAO,MAAI,CAACa,WAAL,CAAiBT,kBAAjB,CAAP;AACH,aAFM,MAEA;AACH,qBAAO,MAAI,CAACU,WAAL,CAAiBV,kBAAjB,CAAP;AACH;AAP4E;AAQhF;AAED;AACJ;AACA;AACA;;;AACUa,QAAAA,UAAU,CAACC,OAAD,EAAwE;AAAA;AACpF,mBAAOV,MAAM,CAACC,OAAP,CAAeC,OAAf,CAAuBR,QAAvB,EAAiC,qBAAjC,EAAwDgB,OAAxD,CAAP;AADoF;AAEvF;AAED;AACJ;AACA;AACA;;;AACUL,QAAAA,WAAW,CAAIM,QAAJ,EAA8C;AAAA;;AAAA;AAC3D,gBAAMC,MAAM,SAAS,MAAI,CAACC,SAAL,CAAef,iBAAf,CAArB;AACA,gBAAI,CAACc,MAAL,EAAa,OAAOE,SAAP;AACb,gBAAMC,SAAS,SAAS,MAAI,CAACC,WAAL,CAAiBJ,MAAjB,EAAyBD,QAAzB,CAAxB;AACA,gBAAI,CAACI,SAAD,IAAc,CAACA,SAAS,CAACE,IAA7B,EAAmC,OAAOH,SAAP;AACnC,mBAAOC,SAAS,CAACE,IAAjB;AAL2D;AAM9D;AAED;AACJ;AACA;AACA;;;AACUX,QAAAA,WAAW,CAAIY,OAAJ,EAA6C;AAAA;AAC1D,gBAAI;AACA,2BAAa,OAAOC,KAAK,CAAIzB,QAAJ,SAAgBwB,OAAhB,CAAZ,EAAwCD,IAAxC,EAAb;AACH,aAFD,CAEE,OAAOG,CAAP,EAAU;AACR,qBAAON,SAAP;AACH;AALyD;AAM7D;;AAEKO,QAAAA,WAAW,CAACC,UAAD,EAAuC;AAAA;AACpD,gBAAMC,WAAyD,GAAGjC,QAAQ,CAACkC,aAAT,CAA8DjC,QAAQ,CAACkC,QAAT,CAAkBC,MAAhF,EAAwF,gBAAxF,CAAlE;AACA,gBAAMd,MAAM,GAAGW,WAAH,oBAAGA,WAAW,CAAEI,IAAb,CAAmBC,EAAD,IAAQA,EAAE,CAAChB,MAAH,KAAcU,UAAxC,CAAf;AACA,mBAAO,CAAC,CAACV,MAAT;AAHoD;AAIvD;;AAEKC,QAAAA,SAAS,CAACS,UAAD,EAA+D;AAAA;AAC1E,mBAAO,IAAIO,OAAJ,CAAYC,OAAO,IAAI;AAC1BzC,cAAAA,YAAY,CAAC0C,UAAb,CAAwBT,UAAxB,EAAoC,CAACU,KAAD,EAAQpB,MAAR,KAAwC;AACxE,oBAAIoB,KAAJ,EAAW;AACPF,kBAAAA,OAAO,CAAChB,SAAD,CAAP;AACH,iBAFD,MAEO;AACHgB,kBAAAA,OAAO,CAAClB,MAAD,CAAP;AACH;AACJ,eAND;AAOH,aARM,CAAP;AAD0E;AAU7E;;AAEKI,QAAAA,WAAW,CAACJ,MAAD,EAA8BqB,YAA9B,EAAoF;AAAA;AACjG,mBAAO,IAAIJ,OAAJ,CAAYC,OAAO,IAAI;AAC1BlB,cAAAA,MAAM,CAACsB,IAAP,CAAYD,YAAZ,EAA0B,CAACD,KAAD,EAAQG,KAAR,KAA6B;AACnD,oBAAIH,KAAJ,EAAW;AACPF,kBAAAA,OAAO,CAAChB,SAAD,CAAP;AACH,iBAFD,MAEO;AACHgB,kBAAAA,OAAO,CAACK,KAAD,CAAP;AACH;AACJ,eAND;AAOH,aARM,CAAP;AADiG;AAUpG;;AAlFoC,O","sourcesContent":["// @ts-ignore\r\nimport { BUILD, EDITOR } from 'cc/env';\r\nimport { AssetManager, assetManager, JsonAsset, settings, Settings } from 'cc';\r\nimport { ResourceBundle, ResourceList } from './l10n-options';\r\nimport { mainName, pluginName, resourceBundlePath, resourceListPath, runtimeBundleName } from './localization-global';\r\n\r\nexport default class ResourceDataManager {\r\n    async readResourceList(): Promise<ResourceList> {\r\n        if (EDITOR) {\r\n            return Editor.Message.request(mainName, 'get-resource-list');\r\n        } else if (BUILD) {\r\n            console.log(`[${pluginName}] this is build env`);\r\n            return this.runtimeLoad(resourceListPath);\r\n        } else {\r\n            return this.previewLoad(resourceListPath);\r\n        }\r\n    }\r\n\r\n    async readResourceBundle(tags: Intl.BCP47LanguageTag[]): Promise<ResourceBundle> {\r\n        if (EDITOR) {\r\n            return this.editorLoad(tags);\r\n        } else if (BUILD) {\r\n            return this.runtimeLoad(resourceBundlePath);\r\n        } else {\r\n            return this.previewLoad(resourceBundlePath);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 编辑器模式下使用\r\n     * @param locales\r\n     */\r\n    async editorLoad(locales: Intl.BCP47LanguageTag[]): Promise<ResourceBundle | undefined> {\r\n        return Editor.Message.request(mainName, 'get-resource-bundle', locales);\r\n    }\r\n\r\n    /**\r\n     * 构建后运行时使用\r\n     * @param fileName\r\n     */\r\n    async runtimeLoad<T>(fileName: string): Promise<T | undefined> {\r\n        const bundle = await this.getBundle(runtimeBundleName);\r\n        if (!bundle) return undefined;\r\n        const jsonAsset = await this.getResource(bundle, fileName);\r\n        if (!jsonAsset || !jsonAsset.json) return undefined;\r\n        return jsonAsset.json as any as T;\r\n    }\r\n\r\n    /**\r\n     * 浏览器预览使用\r\n     * @param urlPath\r\n     */\r\n    async previewLoad<T>(urlPath: string): Promise<T | undefined> {\r\n        try {\r\n            return await (await fetch(`${mainName}/${urlPath}`)).json() as T;\r\n        } catch (e) {\r\n            return undefined;\r\n        }\r\n    }\r\n\r\n    async checkBundle(bundleName: string): Promise<boolean> {\r\n        const queryResult: { bundle: string, version: string }[] | null = settings.querySettings<{ bundle: string, version: string }[]>(Settings.Category.ASSETS, 'preloadBundles');\r\n        const bundle = queryResult?.find((it) => it.bundle === bundleName);\r\n        return !!bundle;\r\n    }\r\n\r\n    async getBundle(bundleName: string): Promise<AssetManager.Bundle | undefined> {\r\n        return new Promise(resolve => {\r\n            assetManager.loadBundle(bundleName, (error, bundle: AssetManager.Bundle) => {\r\n                if (error) {\r\n                    resolve(undefined);\r\n                } else {\r\n                    resolve(bundle);\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    async getResource(bundle: AssetManager.Bundle, resourceName: string): Promise<JsonAsset | undefined> {\r\n        return new Promise(resolve => {\r\n            bundle.load(resourceName, (error, asset: JsonAsset) => {\r\n                if (error) {\r\n                    resolve(undefined);\r\n                } else {\r\n                    resolve(asset);\r\n                }\r\n            });\r\n        });\r\n    }\r\n}\r\n"]}